# ============================================================
# Basic
# ============================================================
unbind C-b
set -g prefix F12

# C-a = IME off + enter prefix mode + refresh status
bind -T root C-a run-shell -b "fcitx5-remote -c" \; switch-client -T prefix \; refresh-client -S
# C-a C-a = send literal C-a to shell
bind C-a send-keys C-a

set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g mouse on
setw -g mode-keys vi
set -g set-clipboard on

# True color
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# Clipboard (xclip) - Vim-like keybinds
bind -T copy-mode-vi v     send-keys -X begin-selection
bind -T copy-mode-vi V     send-keys -X select-line
bind -T copy-mode-vi C-v   send-keys -X rectangle-toggle
bind -T copy-mode-vi y     send-keys -X copy-pipe-and-cancel "xclip -in -selection clipboard"
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "xclip -in -selection clipboard"
bind -T copy-mode-vi Escape send-keys -X cancel
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -in -selection clipboard"

# ============================================================
# Keybinds
# ============================================================
# Split panes
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Pane navigation (hjkl) - repeat可
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Pane navigation (Alt+hjkl) - prefix不要
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Pane resize (HJKL)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ============================================================
# Hints (popup cheatsheet)  [tmux 3.2+]
# ============================================================
bind ? display-popup -E -w 90% -h 80% "cat <<'EOF' | less
TMUX チートシート (^a = リーダーキー)

── ペイン ──────────────────────────
  ^a |       横に分割
  ^a -       縦に分割
  ^a h j k l ペイン移動 (左下上右)
  ^a H J K L ペインリサイズ
  ^a z       ズーム (全画面切替)
  ^a x       ペインを閉じる

── ウィンドウ ──────────────────────
  ^a c       新規ウィンドウ
  ^a n / p   次 / 前のウィンドウ
  ^a 1-9     番号で切替
  ^a a       直前のウィンドウに戻る

── レイアウト ──────────────────────
  ^a M-1     均等横並び
  ^a M-2     均等縦並び
  ^a M-3     メイン左+右に小ペイン
  ^a M-4     メイン上+下に小ペイン
  ^a M-5     タイル状

── コピー (Vim操作) ────────────────
  ^a [       コピーモード開始
    v        選択開始
    V        行選択
    C-v      矩形選択
    y/Enter  コピー (クリップボードへ)
    Escape   キャンセル

── セッション ──────────────────────
  ^a d       デタッチ
  ^a C-s     セッション保存
  ^a C-r     セッション復元 (自動保存15分毎)
  ^a C-a     シェルにCtrl-aを送信
  ^a ?       このヘルプ
  ^a Space   which-key メニュー
  ^a R       設定リロード
EOF"

# ============================================================
# Plugins (TPM)
# ============================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'arcticicestudio/nord-tmux'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# resurrect: プロセスも復元
set -g @resurrect-capture-pane-contents 'on'

# continuum: 15分ごと自動保存 + tmux起動時に自動復元
set -g @continuum-save-interval '15'
set -g @continuum-restore 'on'

# prefix-highlight
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_show_sync_mode 'on'

# ============================================================
# TPM init
# ============================================================
run '~/.tmux/plugins/tpm/tpm'

# ============================================================
# Hints (status line) - AFTER TPM to override nord-tmux
# ============================================================
# client_key_table で prefix 中を検知 (F12疑似prefix対応)
set -g status-right-length 120
set -g status-right "#{?#{==:#{client_key_table},prefix}, |:横割  -:縦割  hjkl:移動  HJKL:拡縮  [:コピー  C-s:保存  C-r:復元  ?:ヘルプ ,} %Y-%m-%d %H:%M"
set -g status-interval 1

# nord-tmux の色上書き: 非アクティブタブ・ヒントをピンクに
set -g window-status-format "#[fg=brightblack,bg=brightblack,nobold,noitalics,nounderscore] #[fg=#ff79c6,bg=brightblack]#I #[fg=#ff79c6,bg=brightblack,nobold,noitalics,nounderscore] #[fg=#ff79c6,bg=brightblack]#W #F #[fg=brightblack,bg=black,nobold,noitalics,nounderscore]"
set -g status-right-style "fg=#ff79c6"
set -g message-style "bg=brightblack,fg=#ff79c6"
set -g message-command-style "bg=brightblack,fg=#ff79c6"
